<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Family Bible Reading</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bible Reading">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
  <meta name="theme-color" content="#0ea5e9">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root{
      --bg: #f8fafc; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --accent:#0ea5e9;
      --adult-start:#f0f9ff; --adult-end:#e0f2fe;
      /* Overlay for kids image backgrounds in LIGHT */
      --kid-overlay: rgba(255,255,255,.78);
    }
    [data-theme="dark"]{
      --bg:#0b1020; --card:#0f172a; --border:#1f2a44; --text:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee;
      --adult-start:#0f1b2a; --adult-end:#0b2a3a;
      /* Overlay for kids image backgrounds in DARK */
      --kid-overlay: rgba(0,0,0,.45);
    }
    @media (prefers-color-scheme: dark){
      [data-theme="auto"]{
        --bg:#0b1020; --card:#0f172a; --border:#1f2a44; --text:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee;
        --adult-start:#0f1b2a; --adult-end:#0b2a3a;
        --kid-overlay: rgba(0,0,0,.45);
      }
    }
    body{ background: var(--bg); color: var(--text); }
    .card { background: var(--card); border:1px solid var(--border); }
    .adult-card { background: linear-gradient(180deg,var(--adult-start),var(--adult-end)); border:1px solid var(--border); }
    .completed { border-color:#10b981!important; box-shadow:0 0 0 2px #10b98133 inset; }
    .kid-sticker { width: 112px; height: 112px; border-radius: 28px; object-fit: cover; box-shadow: 0 12px 28px rgba(0,0,0,.2); }
    .muted{ color: var(--muted); }
    .bordered{ border:1px solid var(--border); }
    .theme-toggle{ border:1px solid var(--border); }
    .short-pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(14,165,233,.12); color: var(--accent); border: 1px solid rgba(14,165,233,.3); cursor: pointer; }
    .confetti { position: fixed; left: 0; top: 0; pointer-events: none; width: 100%; height: 100%; overflow: hidden; }
    .piece { position: absolute; font-size: 22px; animation: fall 1200ms ease-in forwards; opacity: .9; }
    @keyframes fall { to { transform: translate(var(--dx), var(--dy)) rotate(540deg); opacity: 0; } }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 50; padding: 16px; }
    .modal { background: var(--card); border:1px solid var(--border); border-radius: 16px; max-width: 680px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,.35); }
    .btn-fun { background: linear-gradient(90deg,#22d3ee,#60a5fa); color: white; border: none; }

    /* --- Kids card faded background helpers --- */
    .kid-card-bg { position:relative; overflow:hidden; }
    .kid-card-bg .bg-img { position:absolute; inset:0; background-size:cover; background-position:center; filter:saturate(105%) contrast(95%); }
    .kid-card-bg .bg-fade { position:absolute; inset:0; background:var(--kid-overlay); }
    .kid-card-bg .content { position:relative; z-index:10; }
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center gap-3 mb-4">
      <img src="header-logo.png" alt="Open Bible" width="40" height="40" class="rounded-xl" />
      <div class="flex-1">
        <h1 class="text-2xl font-bold">Family Bible Reading</h1>
        <p class="text-sm muted">Adults (ESV) ‚Ä¢ Kids Stories (NIrV)</p>
      </div>
      <div class="text-right">
        <div class="text-sm muted">Progress</div>
        <div class="text-lg font-semibold" id="progressPct">0%</div>
      </div>
    </header>

    <div class="flex flex-wrap items-center gap-2 mb-3">
      <label class="text-sm">User:</label>
      <select class="bordered rounded p-2 bg-transparent" id="user"></select>
      <button class="ml-auto px-3 py-2 rounded bordered bg-transparent" id="yesterday">‚Üê Yesterday</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="tomorrow">Tomorrow ‚Üí</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="prev">‚óÄ Previous</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="next">Next ‚ñ∂</button>
      <button class="px-3 py-2 rounded bg-green-600 text-white" id="markAll">Mark all complete</button>
      <div class="ml-2">
        <select id="theme" class="theme-toggle rounded p-2 bg-transparent">
          <option value="auto">Theme: Auto</option>
          <option value="light">Theme: Light</option>
          <option value="dark">Theme: Dark</option>
        </select>
      </div>
      <div class="ml-2">
        <select id="overview" class="theme-toggle rounded p-2 bg-transparent">
          <option value="single">View: Single</option>
          <option value="kids">View: Kids Overview</option>
        </select>
      </div>
    </div>

    <div id="cards" class="grid gap-3"></div>

    <div class="mt-6 p-4 rounded-2xl card">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm muted">Peek ahead</div>
          <div class="text-lg font-semibold" id="peekTitle">Tomorrow</div>
        </div>
        <button id="restartStories" class="px-3 py-2 rounded btn-fun hidden">üîÑ Restart Story Plan</button>
      </div>
      <div id="peek" class="grid gap-3 mt-3"></div>
    </div>

    <footer class="text-center text-xs muted mt-6">
      Add to iOS Home Screen: Share ‚Üí ‚ÄúAdd to Home Screen‚Äù (online use; offline caching disabled).
    </footer>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <!-- Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="p-4 flex items-center gap-3 border-b" style="border-color: var(--border)">
        <img id="modalImg" src="" alt="" class="w-14 h-14 rounded-xl object-cover bordered" />
        <div>
          <div id="modalTitle" class="font-semibold"></div>
          <div id="modalRef" class="text-sm muted"></div>
        </div>
        <button id="modalClose" class="ml-auto px-3 py-1 rounded bordered bg-transparent">Close</button>
      </div>
      <div id="modalBody" class="p-4 text-sm leading-relaxed"></div>
      <div class="p-4 border-t" style="border-color: var(--border)">
        <a id="modalLink" href="#" target="_blank" rel="noreferrer" class="text-sm underline">Open passage on BibleGateway</a>
      </div>
    </div>
  </div>

<script>
// ---- Theme ----
(function(){
  const KEY_THEME='fbr-theme';
  function applyTheme(val){ document.documentElement.setAttribute('data-theme', val||'auto'); try{ localStorage.setItem(KEY_THEME, val||'auto'); }catch(e){} }
  const saved = (function(){ try{return localStorage.getItem(KEY_THEME);}catch(e){return null;}})();
  applyTheme(saved||'auto');
  window._setTheme = applyTheme;
})();

// ---- Book list ----
const BOOKS=[
  {n:'Genesis',c:50},{n:'Exodus',c:40},{n:'Leviticus',c:27},{n:'Numbers',c:36},{n:'Deuteronomy',c:34},
  {n:'Joshua',c:24},{n:'Judges',c:21},{n:'Ruth',c:4},{n:'1 Samuel',c:31},{n:'2 Samuel',c:24},
  {n:'1 Kings',c:22},{n:'2 Kings',c:25},{n:'1 Chronicles',c:29},{n:'2 Chronicles',c:36},{n:'Ezra',c:10},
  {n:'Nehemiah',c:13},{n:'Esther',c:10},{n:'Job',c:42},{n:'Psalms',c:150},{n:'Proverbs',c:31},
  {n:'Ecclesiastes',c:12},{n:'Song of Solomon',c:8},{n:'Isaiah',c:66},{n:'Jeremiah',c:52},{n:'Lamentations',c:5},
  {n:'Ezekiel',c:48},{n:'Daniel',c:12},{n:'Hosea',c:14},{n:'Joel',c:3},{n:'Amos',c:9},
  {n:'Obadiah',c:1},{n:'Jonah',c:4},{n:'Micah',c:7},{n:'Nahum',c:3},{n:'Habakkuk',c:3},
  {n:'Zephaniah',c:3},{n:'Haggai',c:2},{n:'Zechariah',c:14},{n:'Malachi',c:4},
  {n:'Matthew',c:28},{n:'Mark',c:16},{n:'Luke',c:24},{n:'John',c:21},{n:'Acts',c:28},
  {n:'Romans',c:16},{n:'1 Corinthians',c:16},{n:'2 Corinthians',c:13},{n:'Galatians',c:6},{n:'Ephesians',c:6},
  {n:'Philippians',c:4},{n:'Colossians',c:4},{n:'1 Thessalonians',c:5},{n:'2 Thessalonians',c:3},
  {n:'1 Timothy',c:6},{n:'2 Timothy',c:4},{n:'Titus',c:3},{n:'Philemon',c:1},{n:'Hebrews',c:13},
  {n:'James',c:5},{n:'1 Peter',c:5},{n:'2 Peter',c:3},{n:'1 John',c:5},{n:'2 John',c:1},{n:'3 John',c:1},
  {n:'Jude',c:1},{n:'Revelation',c:22}
];
const flatten=[]; const bookStartIndex={};
BOOKS.forEach(b=>{ bookStartIndex[b.n] = flatten.length; for(let i=1;i<=b.c;i++) flatten.push({book:b.n,chapter:i}); });

// ---- Helpers ----
const refToUrl=(book,st,en,ver)=>{ const r=(en&&en!==st)?`${book} ${st}-${en}`:`${book} ${st}`; return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(r)}&version=${encodeURIComponent(ver)}`; };
function dayOfYear(d=new Date()){ return Math.floor((d - new Date(d.getFullYear(),0,1))/86400000); }
function toRef(book,start,end){ return start===end? (book+' '+start) : (book+' '+start+'-'+end); }

// ---- Adult plan (ESV) ----
function dailyDistribution(total,days=365){ const out=[]; for(let d=0; d<days; d++){ const t=Math.round(((d+1)*total)/days); const p=Math.round((d*total)/days); out.push(t-p);} return out; }
function buildRanges(counts,startIdx){ const out=[]; let idx=startIdx; for(const n of counts){ let start=flatten[idx]; let left=n; let last=start; while(left>0 && idx<flatten.length){ last=flatten[idx]; idx++; left--; } out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter}); } return out; }
function buildRangesLoop(counts, startIdx, endIdx){
  const out=[]; let idx=startIdx; for(const n of counts){ let start=flatten[idx]; let left = n; let last=start;
    while(left>0){ last=flatten[idx]; idx++; if(idx>=endIdx) idx=startIdx; left--; } out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter}); }
  return out;
}
const NT_START = bookStartIndex['Matthew']; const NT_END = flatten.length;
const OT_CHAPTERS = NT_START; const NT_CHAPTERS = NT_END - NT_START;
const otPerDay = dailyDistribution(OT_CHAPTERS,365); const ntPerDay = dailyDistribution(NT_CHAPTERS*2,365);
const OT_RANGES = buildRanges(otPerDay, 0); const NT_RANGES = buildRangesLoop(ntPerDay, NT_START, NT_END);
function psPrForDay(d){ if(d%2===0){ const ps=Math.floor(d/2)%150+1; return {book:'Psalms',start:ps,end:ps}; } const pr=Math.floor(d/2)%31+1; return {book:'Proverbs',start:pr,end:pr}; }
function adultDay(d){ const ot=OT_RANGES[d], nt=NT_RANGES[d], pp=psPrForDay(d);
  return [{label:'Old Testament', book:ot.startBook, start:ot.startCh, end:ot.endCh, version:'ESV'},
          {label:'New Testament', book:nt.startBook, start:nt.startCh, end:nt.endCh, version:'ESV'},
          {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'ESV'}]; }

// ---- Kids stories data ----
const STORIES_OT = [{"title":"Creation","book":"Genesis","start":1,"end":2,"short":"God creates","long":"God made the world good and people in His image.","img":"story-creation.png"},{"title":"Adam & Eve","book":"Genesis","start":3,"end":3,"short":"First family","long":"Adam and Eve disobeyed God, but He promised a Savior.","img":"ph-adam---eve.png"},{"title":"Noah‚Äôs Ark","book":"Genesis","start":6,"end":9,"short":"God rescues","long":"God saved Noah‚Äôs family and set a rainbow promise.","img":"story-noah.png"},{"title":"Tower of Babel","book":"Genesis","start":11,"end":11,"short":"Proud tower","long":"God scattered people by confusing their language.","img":"ph-tower-of-babel.png"},{"title":"God‚Äôs Promise to Abram","book":"Genesis","start":12,"end":15,"short":"Stars promise","long":"God promised Abram a big family to bless the world.","img":"ph-god-s-promise-to-abram.png"},{"title":"Joseph‚Äôs Dreams","book":"Genesis","start":37,"end":37,"short":"God at work","long":"God used Joseph‚Äôs trials to save many people.","img":"ph-joseph-s-dreams.png"},{"title":"Moses & Burning Bush","book":"Exodus","start":3,"end":3,"short":"God calls","long":"God sent Moses to free His people.","img":"ph-moses---burning-bush.png"},{"title":"Crossing the Red Sea","book":"Exodus","start":14,"end":14,"short":"Sea parts","long":"God rescued Israel through the sea.","img":"ph-crossing-the-red-sea.png"},{"title":"Ten Commandments","book":"Exodus","start":20,"end":20,"short":"God‚Äôs ways","long":"God gave good commands for life.","img":"ph-ten-commandments.png"},{"title":"Walls of Jericho","book":"Joshua","start":6,"end":6,"short":"Walls fall","long":"God brought the walls down as Israel obeyed.","img":"ph-walls-of-jericho.png"},{"title":"Gideon‚Äôs Victory","book":"Judges","start":7,"end":7,"short":"Small but brave","long":"God saved Israel with a small army.","img":"ph-gideon-s-victory.png"},{"title":"David & Goliath","book":"1 Samuel","start":17,"end":17,"short":"Brave faith","long":"David trusted God and beat the giant.","img":"story-david-goliath.png"},{"title":"Elijah on Mount Carmel","book":"1 Kings","start":18,"end":18,"short":"God answers","long":"God showed His power over false gods.","img":"ph-elijah-on-mount-carmel.png"},{"title":"Elisha Helps","book":"2 Kings","start":4,"end":4,"short":"Kind miracles","long":"God cared for people through Elisha.","img":"ph-elisha-helps.png"},{"title":"Queen Esther","book":"Esther","start":4,"end":7,"short":"For such time","long":"God used Esther to protect His people.","img":"ph-queen-esther.png"},{"title":"Daniel in Lions‚Äô Den","book":"Daniel","start":6,"end":6,"short":"God protects","long":"God kept Daniel safe with the lions.","img":"ph-daniel-in-lions--den.png"},{"title":"Jonah & Big Fish","book":"Jonah","start":1,"end":2,"short":"Second chance","long":"God gave Jonah and Nineveh mercy.","img":"story-jonah.png"}];
const STORIES_NT = [{"title":"Jesus Is Born","book":"Luke","start":2,"end":2,"short":"Savior born","long":"Jesus was born in Bethlehem‚Äîgood news of great joy!","img":"story-nativity.png"},{"title":"Boy Jesus at the Temple","book":"Luke","start":2,"end":41,"short":"Growing in wisdom","long":"Jesus loved His Father‚Äôs house.","img":"ph-boy-jesus-at-the-temple.png"},{"title":"Baptism of Jesus","book":"Matthew","start":3,"end":3,"short":"Loved Son","long":"The Father said, ‚ÄúThis is my beloved Son.‚Äù","img":"ph-baptism-of-jesus.png"},{"title":"Jesus Calms the Storm","book":"Mark","start":4,"end":35,"short":"Peace be still","long":"Jesus spoke and the sea became calm.","img":"ph-jesus-calms-the-storm.png"},{"title":"Feeding 5,000","book":"John","start":6,"end":1,"short":"God provides","long":"Jesus fed a crowd with little food.","img":"ph-feeding-5-000.png"},{"title":"Good Samaritan","book":"Luke","start":10,"end":25,"short":"Love neighbors","long":"Jesus taught us to show mercy.","img":"ph-good-samaritan.png"},{"title":"Prodigal Son","book":"Luke","start":15,"end":11,"short":"Father‚Äôs love","long":"The father welcomed his son home with joy.","img":"ph-prodigal-son.png"},{"title":"Good Shepherd","book":"John","start":10,"end":1,"short":"Jesus cares","long":"Jesus knows and leads His sheep.","img":"ph-good-shepherd.png"},{"title":"Zacchaeus","book":"Luke","start":19,"end":1,"short":"Changed heart","long":"Jesus welcomed Zacchaeus; his life changed.","img":"ph-zacchaeus.png"},{"title":"Palm Sunday","book":"Matthew","start":21,"end":1,"short":"Hail the King","long":"Jesus entered Jerusalem as promised King.","img":"ph-palm-sunday.png"},{"title":"Last Supper","book":"Luke","start":22,"end":7,"short":"New covenant","long":"Jesus gave bread and cup to remember Him.","img":"ph-last-supper.png"},{"title":"Cross & Resurrection","book":"Luke","start":23,"end":24,"short":"Jesus wins","long":"Jesus died and rose to save us.","img":"ph-cross---resurrection.png"},{"title":"Doubting Thomas","book":"John","start":20,"end":24,"short":"Believe & see","long":"Jesus showed His wounds; Thomas believed.","img":"ph-doubting-thomas.png"},{"title":"Great Commission","book":"Matthew","start":28,"end":16,"short":"Go and tell","long":"Jesus sent us to make disciples.","img":"ph-great-commission.png"},{"title":"Pentecost","book":"Acts","start":2,"end":1,"short":"Spirit comes","long":"God sent the Holy Spirit to the church.","img":"ph-pentecost.png"},{"title":"Peter in Prison","book":"Acts","start":12,"end":1,"short":"God sets free","long":"An angel rescued Peter from chains.","img":"ph-peter-in-prison.png"},{"title":"Paul‚Äôs Conversion","book":"Acts","start":9,"end":1,"short":"New start","long":"Jesus met Saul; he became Paul.","img":"ph-paul-s-conversion.png"},{"title":"Paul & Silas Sing","book":"Acts","start":16,"end":16,"short":"Joy in jail","long":"God shook the prison; the jailer believed.","img":"ph-paul---silas-sing.png"},{"title":"Armor of God","book":"Ephesians","start":6,"end":10,"short":"Stand strong","long":"God gives armor to live for Him.","img":"ph-armor-of-god.png"},{"title":"Fruit of the Spirit","book":"Galatians","start":5,"end":22,"short":"Grow like Jesus","long":"The Spirit grows love and joy in us.","img":"ph-fruit-of-the-spirit.png"}];

// ---- State (new key resets kids progress) ----
const KEY='fbr-full2-otnt-stories';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch{return{};} }
function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }
const defaultProfiles=[{id:'dad',name:'Dad',type:'adult'},{id:'mom',name:'Mom',type:'adult'},{id:'elle',name:'Elle',type:'kid'},{id:'lainey',name:'Lainey',type:'kid'}];
let S = Object.assign({profiles: defaultProfiles, activeId:'dad', offset:0, completed:{}, view:'single',
  kidsCycle:{ otOrder:[], ntOrder:[], otIdx:0, ntIdx:0 }
}, load());

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function ensureOrders(){
  if(!S.kidsCycle) S.kidsCycle={ otOrder:[], ntOrder:[], otIdx:0, ntIdx:0 };
  if(!Array.isArray(S.kidsCycle.otOrder) || S.kidsCycle.otOrder.length!==STORIES_OT.length){ S.kidsCycle.otOrder = shuffle([...Array(STORIES_OT.length).keys()]); S.kidsCycle.otIdx=0; }
  if(!Array.isArray(S.kidsCycle.ntOrder) || S.kidsCycle.ntOrder.length!==STORIES_NT.length){ S.kidsCycle.ntOrder = shuffle([...Array(STORIES_NT.length).keys()]); S.kidsCycle.ntIdx=0; }
}
ensureOrders();

// ---- helper to apply faded background to a card ----
function applyFadedBg(cardEl, imgPath){
  cardEl.classList.add('kid-card-bg');
  const bg = document.createElement('div');
  bg.className = 'bg-img';
  bg.style.backgroundImage = `url(${imgPath})`;
  const fade = document.createElement('div');
  fade.className = 'bg-fade';
  const content = document.createElement('div');
  content.className = 'content';
  cardEl.appendChild(bg);
  cardEl.appendChild(fade);
  cardEl.appendChild(content);
  return content; // append the rest of the card into this
}

// selector: alternate OT/NT by calendar day parity, always start with OT today
function kidsToday(){
  ensureOrders();
  const parity = (dayOfYear() + S.offset + 3650) % 2; // 0 OT, 1 NT
  if(parity===0){
    if(S.kidsCycle.otIdx>=STORIES_OT.length){ S.kidsCycle.otOrder=shuffle(S.kidsCycle.otOrder); S.kidsCycle.otIdx=0; }
    const st = STORIES_OT[S.kidsCycle.otOrder[S.kidsCycle.otIdx]];
    return Object.assign({side:'OT'}, st);
  }else{
    if(S.kidsCycle.ntIdx>=STORIES_NT.length){ S.kidsCycle.ntOrder=shuffle(S.kidsCycle.ntOrder); S.kidsCycle.ntIdx=0; }
    const st = STORIES_NT[S.kidsCycle.ntOrder[S.kidsCycle.ntIdx]];
    return Object.assign({side:'NT'}, st);
  }
}
function kidsTomorrow(){
  const parity = (dayOfYear() + S.offset + 1 + 3650) % 2;
  if(parity===0){
    const id = (S.kidsCycle.otIdx>=STORIES_OT.length?0:S.kidsCycle.otIdx);
    return Object.assign({side:'OT'}, STORIES_OT[S.kidsCycle.otOrder[id]]);
  }else{
    const id = (S.kidsCycle.ntIdx>=STORIES_NT.length?0:S.kidsCycle.ntIdx);
    return Object.assign({side:'NT'}, STORIES_NT[S.kidsCycle.ntOrder[id]]);
  }
}

// advance when a kid marks complete (increments index for that side)
function advanceKids(side){
  if(side==='OT'){ S.kidsCycle.otIdx++; } else { S.kidsCycle.ntIdx++; }
  save(S);
}

// completion
function isDone(pid, day, i){ const arr=S.completed[pid+':'+day]||[]; return arr.indexOf(i)!==-1; }
function toggle(pid, day, i, meta){ const k=pid+':'+day; const set=new Set(S.completed[k]||[]); if(set.has(i)) set.delete(i); else set.add(i); S.completed[k]=Array.from(set); save(S); if(meta&&meta.side){ advanceKids(meta.side); } confetti(); render(); }
function markAll(pid, day, len, meta){ S.completed[pid+':'+day]=Array.from({length:len},(_,i)=>i); save(S); if(meta&&meta.side){ advanceKids(meta.side); } confetti(); render(); }
function percent(pid, type){ let done=0; for(let d=0; d<=dayOfYear(); d++){ const key=pid+':'+d; const need=(type==='adult'?3:1); if((S.completed[key]||[]).length>=need) done++; } return Math.round((done/(dayOfYear()+1))*100); }

// confetti
function confetti(){ const host=document.getElementById('confetti'); if(!host) return; const pieces=16; const W=window.innerWidth, H=window.innerHeight; for(let i=0;i<pieces;i++){ const s=document.createElement('div'); s.className='piece'; s.style.left=(W/2)+'px'; s.style.top=(H/3)+'px'; const dx=(Math.random()*2-1)*W*0.6; const dy=H*(0.6+Math.random()*0.4); s.style.setProperty('--dx', dx+'px'); s.style.setProperty('--dy', dy+'px'); s.textContent=['üéâ','‚ú®','üåü','üí´','üéà','üü°','üü£','üîµ'][i%8]; host.appendChild(s); setTimeout(()=> host.removeChild(s),1300);} }

// modal
function openModal(imgSrc, title, ref, body, link){
  const bg = document.getElementById('modalBg');
  document.getElementById('modalImg').src = imgSrc||'';
  document.getElementById('modalTitle').textContent = title||'';
  document.getElementById('modalRef').textContent = ref||'';
  document.getElementById('modalBody').textContent = body||'';
  document.getElementById('modalLink').href = link||'#';
  bg.style.display='flex';
}
document.getElementById('modalClose').onclick = ()=>{ document.getElementById('modalBg').style.display='none'; };
document.getElementById('modalBg').onclick = (e)=>{ if(e.target.id==='modalBg'){ e.currentTarget.style.display='none'; } };

// controls
(function(){
  const viewSel = document.getElementById('overview');
  viewSel.value = (load().view || 'single');
  viewSel.onchange = e=>{ S.view = e.target.value; save(S); render(); };
  const themeSel=document.getElementById('theme');
  try{ themeSel.value = localStorage.getItem('fbr-theme')||'auto'; }catch(e){ themeSel.value='auto'; }
  themeSel.onchange = (e)=>{ const v=e.target.value||'auto'; if(window._setTheme) window._setTheme(v); };
})();

// restart button (parents only in kids overview)
function showRestartIfParent(){
  const btn = document.getElementById('restartStories');
  const p = S.profiles.find(x=>x.id===S.activeId)||S.profiles[0];
  if(S.view==='kids' && p.type==='adult'){
    btn.classList.remove('hidden');
    btn.onclick = ()=>{
      if(confirm('Restart kids story plan? This resets Elle and Lainey progress and reshuffles stories.')){
        S.completed = {};
        S.kidsCycle = { otOrder:[], ntOrder:[], otIdx:0, ntIdx:0 };
        ensureOrders();
        save(S);
        render();
      }
    };
  }else{
    btn.classList.add('hidden');
  }
}

// render helpers
function shortPill(text, onClick){ const s=document.createElement('span'); s.className='short-pill'; s.textContent=text; s.onclick=onClick; return s; }

function render(){
  showRestartIfParent();
  const userSel = document.getElementById('user');
  userSel.innerHTML='';
  S.profiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(p.id===S.activeId) o.selected=true; userSel.appendChild(o); });
  userSel.onchange = e=>{ S.activeId=e.target.value; save(S); render(); };

  const p = S.profiles.find(x=>x.id===S.activeId)||S.profiles[0];
  document.getElementById('progressPct').textContent = percent(p.id, p.type)+'%';
  const cards = document.getElementById('cards');
  cards.innerHTML='';

  // Wire nav (prev/next just slide offset)
  document.getElementById('yesterday').onclick = ()=>{ S.offset--; render(); };
  document.getElementById('tomorrow').onclick  = ()=>{ S.offset++; render(); };
  document.getElementById('prev').onclick      = ()=>{ S.offset--; render(); };
  document.getElementById('next').onclick      = ()=>{ S.offset++; render(); };
  document.getElementById('markAll').onclick   = ()=>{
    if(p.type==='adult'){ const r=adultDay((dayOfYear()+S.offset+365)%365); markAll(p.id, dayOfYear(), r.length); }
    else { const t=kidsToday(); markAll(p.id, dayOfYear(), 1, {side:t.side}); }
  };

  if(S.view==='kids'){
    // Kids Overview for parents
    const kids = S.profiles.filter(x=>x.type==='kid');
    const today = kidsToday();
    kids.forEach(child=>{
      const st = today;

      // Card with faded story background
      const card=document.createElement('div'); card.className='p-4 rounded-2xl card';
      const content = applyFadedBg(card, 'images/'+st.img);

      const head=document.createElement('div'); head.className='flex items-center gap-3 mb-2';
      const img=document.createElement('img'); img.src='images/'+st.img; img.alt=st.title; img.className='kid-sticker';
      const title=document.createElement('div');
      title.innerHTML = '<div class="text-sm uppercase tracking-wide muted">'+child.name+'</div><div class="text-lg font-semibold">'+st.title+'</div>';
      head.appendChild(img); head.appendChild(title); content.appendChild(head);

      const ref=document.createElement('div'); ref.className='font-medium'; ref.textContent = toRef(st.book, st.start, st.end);
      const link=document.createElement('a'); link.className='text-sm underline'; link.href=refToUrl(st.book, st.start, st.end, 'NIrV'); link.target='_blank'; link.rel='noreferrer'; link.textContent='Read now (NIrV)';
      const pill=shortPill(st.short, ()=>openModal('images/'+st.img, st.title, ref.textContent, st.long, link.href));

      const row=document.createElement('div'); row.className='flex items-center justify-between mt-2';
      const left=document.createElement('div'); left.appendChild(pill); left.appendChild(document.createElement('div')).appendChild(link);
      const btn=document.createElement('button'); btn.className='px-3 py-2 rounded '+(isDone(child.id,dayOfYear(),0)?'bg-green-600 text-white':'bordered bg-transparent'); btn.textContent=isDone(child.id,dayOfYear(),0)?'‚úÖ Done':'Mark complete';
      btn.onclick=()=> toggle(child.id, dayOfYear(), 0, {side:st.side});

      content.appendChild(ref);
      row.appendChild(left); row.appendChild(btn);
      content.appendChild(row);

      cards.appendChild(card);
    });

    // Peek tomorrow
    document.getElementById('peekTitle').textContent = 'Tomorrow (Kids story)';
    const peek=document.getElementById('peek'); peek.innerHTML='';
    const st2 = kidsTomorrow();
    const prow=document.createElement('div'); prow.className='p-3 rounded-xl card flex items-center gap-3';
    const pimg=document.createElement('img'); pimg.src='images/'+st2.img; pimg.alt=st2.title; pimg.className='kid-sticker';
    const l=document.createElement('div');
    const l1=document.createElement('div'); l1.className='text-sm uppercase tracking-wide muted'; l1.textContent='Bible Story';
    const l2=document.createElement('div'); l2.className='font-medium'; l2.textContent=st2.title+' ‚Äî '+toRef(st2.book, st2.start, st2.end);
    l.appendChild(l1); l.appendChild(l2); prow.appendChild(pimg); prow.appendChild(l); peek.appendChild(prow);
  } else {
    if(p.type==='adult'){
      const readings = adultDay((dayOfYear()+S.offset+365)%365);
      readings.forEach((r,i)=>{
        const card=document.createElement('div'); card.className='p-4 rounded-2xl adult-card'+(isDone(p.id,dayOfYear(),i)?' completed':''); 
        const row=document.createElement('div'); row.className='flex items-center gap-4 justify-between';
        const left=document.createElement('div'); left.className='flex-1';
        const tag=document.createElement('div'); tag.className='text-sm uppercase tracking-wide muted'; tag.textContent=r.label;
        const pill=shortPill((r.book==='Psalms'?'Praise & Prayer':(r.book==='Proverbs'?'Wisdom for Life':'Read & Reflect')), ()=>openModal('', r.label, toRef(r.book, r.start, r.end), 'A reading to know God and walk with Him.', refToUrl(r.book,r.start,r.end,r.version)));
        const title=document.createElement('div'); title.className='text-xl font-semibold'; title.textContent=toRef(r.book, r.start, r.end);
        const a=document.createElement('a'); a.className='text-sm underline'; a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')';
        left.appendChild(tag); left.appendChild(pill); left.appendChild(title); left.appendChild(a);
        const btn=document.createElement('button'); btn.className='px-3 py-2 rounded '+(isDone(p.id,dayOfYear(),i)?'bg-green-600 text-white':'bordered bg-transparent'); btn.textContent=isDone(p.id,dayOfYear(),i)?'‚úÖ Done':'Mark complete';
        btn.onclick=()=> toggle(p.id, dayOfYear(), i);
        row.appendChild(left); row.appendChild(btn);
        card.appendChild(row); cards.appendChild(card);
      });
      document.getElementById('peekTitle').textContent = 'Tomorrow (Adults ‚Ä¢ ESV)';
      const peek=document.getElementById('peek'); peek.innerHTML='';
      adultDay((dayOfYear()+S.offset+1+365)%365).forEach((r,i)=>{
        const row=document.createElement('div'); row.className='p-3 rounded-xl card flex items-center justify-between gap-4';
        const l=document.createElement('div');
        const l1=document.createElement('div'); l1.className='text-sm uppercase tracking-wide muted'; l1.textContent=r.label;
        const pill=shortPill((r.book==='Psalms'?'Praise & Prayer':(r.book==='Proverbs'?'Wisdom for Life':'Read & Reflect')), ()=>openModal('', r.label, toRef(r.book, r.start, r.end), 'A reading to know God and walk with Him tomorrow.', refToUrl(r.book,r.start,r.end,r.version)));
        const l2=document.createElement('div'); l2.className='font-medium'; l2.textContent=toRef(r.book, r.start, r.end);
        const a=document.createElement('a'); a.className='text-xs underline'; a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')';
        l.appendChild(l1); l.appendChild(pill); l.appendChild(l2); l.appendChild(a);
        row.appendChild(l); peek.appendChild(row);
      });
    } else {
      // Single kids view (active user is a kid)
      const st = kidsToday();
      const card=document.createElement('div'); card.className='p-4 rounded-2xl card'+(isDone(p.id,dayOfYear(),0)?' completed':'');
      const content = applyFadedBg(card, 'images/'+st.img);

      const row=document.createElement('div'); row.className='flex items-center gap-4 justify-between';
      const left=document.createElement('div'); left.className='flex-1';
      const tag=document.createElement('div'); tag.className='text-sm uppercase tracking-wide muted'; tag.textContent='Bible Story';
      const pill=shortPill(st.short, ()=>openModal('images/'+st.img, st.title, toRef(st.book, st.start, st.end), st.long, refToUrl(st.book,st.start,st.end,'NIrV')));
      const title=document.createElement('div'); title.className='text-xl font-semibold'; title.textContent=st.title+' ‚Äî '+toRef(st.book, st.start, st.end);
      const a=document.createElement('a'); a.className='text-sm underline'; a.href=refToUrl(st.book,st.start,st.end,'NIrV'); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now (NIrV)';
      left.appendChild(tag); left.appendChild(pill); left.appendChild(title); left.appendChild(a);

      const img=document.createElement('img'); img.src='images/'+st.img; img.alt=st.title; img.className='kid-sticker';
      const btn=document.createElement('button'); btn.className='px-3 py-2 rounded '+(isDone(p.id,dayOfYear(),0)?'bg-green-600 text-white':'bordered bg-transparent'); btn.textContent=isDone(p.id,dayOfYear(),0)?'‚úÖ Done':'Mark complete';
      btn.onclick=()=> toggle(p.id, dayOfYear(), 0, {side:st.side});

      row.appendChild(img); row.appendChild(left); row.appendChild(btn);
      content.appendChild(row);
      cards.appendChild(card);

      document.getElementById('peekTitle').textContent = 'Tomorrow (Kids story)';
      const peek=document.getElementById('peek'); peek.innerHTML='';
      const st2 = kidsTomorrow();
      const prow=document.createElement('div'); prow.className='p-3 rounded-xl card flex items-center gap-3';
      const pimg=document.createElement('img'); pimg.src='images/'+st2.img; pimg.alt=st2.title; pimg.className='kid-sticker';
      const l=document.createElement('div');
      const l1=document.createElement('div'); l1.className='text-sm uppercase tracking-wide muted'; l1.textContent='Bible Story';
      const l2=document.createElement('div'); l2.className='font-medium'; l2.textContent=st2.title+' ‚Äî '+toRef(st2.book, st2.start, st2.end);
      l.appendChild(l1); l.appendChild(l2); prow.appendChild(pimg); prow.appendChild(l); peek.appendChild(prow);
    }
  }
}
render();
</script>

<!-- Optional: Logos deep-link patch -->
<!-- <script src="logos-patch.js"></script> -->

</body>
</html>
