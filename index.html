<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Family Bible Reading</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bible Reading">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg: #f8fafc; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --accent:#0ea5e9;
      --adult-start:#f0f9ff; --adult-end:#e0f2fe;
    }
    [data-theme="dark"]{
      --bg:#0b1020; --card:#0f172a; --border:#1f2a44; --text:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee;
      --adult-start:#0f1b2a; --adult-end:#0b2a3a;
    }
    @media (prefers-color-scheme: dark){
      [data-theme="auto"]{
        --bg:#0b1020; --card:#0f172a; --border:#1f2a44; --text:#e2e8f0; --muted:#94a3b8; --accent:#22d3ee;
        --adult-start:#0f1b2a; --adult-end:#0b2a3a;
      }
    }
    body{ background: var(--bg); color: var(--text); }
    .card { background: var(--card); border:1px solid var(--border); }
    .adult-card { background: linear-gradient(180deg,var(--adult-start),var(--adult-end)); border:1px solid var(--border); }
    .completed { border-color:#10b981!important; box-shadow:0 0 0 2px #10b98133 inset; }
    .kid-sticker { width: 96px; height: 96px; border-radius: 24px; object-fit: cover; box-shadow: 0 10px 24px rgba(0,0,0,.18); }
    .muted{ color: var(--muted); }
    .bordered{ border:1px solid var(--border); }
    .theme-toggle{ border:1px solid var(--border); }
    .short-pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(14,165,233,.12); color: var(--accent); border: 1px solid rgba(14,165,233,.3); cursor: pointer; }
    .confetti { position: fixed; left: 0; top: 0; pointer-events: none; width: 100%; height: 100%; overflow: hidden; }
    .piece { position: absolute; font-size: 22px; animation: fall 1200ms ease-in forwards; opacity: .9; }
    @keyframes fall { to { transform: translate(var(--dx), var(--dy)) rotate(540deg); opacity: 0; } }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 50; padding: 16px; }
    .modal { background: var(--card); border:1px solid var(--border); border-radius: 16px; max-width: 680px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,.35); }
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold">Family Bible Reading</h1>
        <p class="text-sm muted">Adults (ESV) • Kids (NIrV) • Mixed plan • Links • Per-person progress</p>
      </div>
      <div class="text-right">
        <div class="text-sm muted">Progress</div>
        <div class="text-lg font-semibold" id="progressPct">0%</div>
      </div>
    </header>

    <div class="flex flex-wrap items-center gap-2 mb-3">
      <label class="text-sm">User:</label>
      <select class="bordered rounded p-2 bg-transparent" id="user"></select>
      <button class="ml-auto px-3 py-2 rounded bordered bg-transparent" id="yesterday">← Yesterday</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="tomorrow">Tomorrow →</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="prev">◀ Previous suggestion</button>
      <button class="px-3 py-2 rounded bordered bg-transparent" id="next">Next suggestion ▶</button>
      <button class="px-3 py-2 rounded bg-green-600 text-white" id="markAll">Mark all complete</button>
      <div class="ml-2">
        <select id="theme" class="theme-toggle rounded p-2 bg-transparent">
          <option value="auto">Theme: Auto</option>
          <option value="light">Theme: Light</option>
          <option value="dark">Theme: Dark</option>
        </select>
      </div>
      <div class="ml-2">
        <select id="overview" class="theme-toggle rounded p-2 bg-transparent">
          <option value="single">View: Single</option>
          <option value="kids">View: Kids Overview</option>
        </select>
      </div>
    </div>

    <div id="cards" class="grid gap-3"></div>

    <div class="mt-6 p-4 rounded-2xl card">
      <div class="text-sm muted">Peek ahead</div>
      <div class="text-lg font-semibold" id="peekTitle">Tomorrow</div>
      <div id="peek" class="grid gap-3 mt-3"></div>
    </div>

    <footer class="text-center text-xs muted mt-6">
      Add to iOS Home Screen: Share → “Add to Home Screen” (online use; offline caching disabled).
    </footer>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <!-- Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="p-4 flex items-center gap-3 border-b" style="border-color: var(--border)">
        <img id="modalImg" src="" alt="" class="w-14 h-14 rounded-xl object-cover bordered" />
        <div>
          <div id="modalTitle" class="font-semibold"></div>
          <div id="modalRef" class="text-sm muted"></div>
        </div>
        <button id="modalClose" class="ml-auto px-3 py-1 rounded bordered bg-transparent">Close</button>
      </div>
      <div id="modalBody" class="p-4 text-sm leading-relaxed"></div>
      <div class="p-4 border-t" style="border-color: var(--border)">
        <a id="modalLink" href="#" target="_blank" rel="noreferrer" class="text-sm underline">Open passage on BibleGateway</a>
      </div>
    </div>
  </div>

<script>
// ---- Theme handling ----
(function(){
  const KEY_THEME='fbr-theme';
  function applyTheme(val){
    document.documentElement.setAttribute('data-theme', val||'auto');
    try{ localStorage.setItem(KEY_THEME, val||'auto'); }catch(e){}
  }
  const saved = (function(){ try{return localStorage.getItem(KEY_THEME);}catch(e){return null;}})();
  applyTheme(saved||'auto');
  window._setTheme = applyTheme;
})();

// ---- Data and helpers ----
const BOOKS=[
  {n:'Genesis',c:50},{n:'Exodus',c:40},{n:'Leviticus',c:27},{n:'Numbers',c:36},{n:'Deuteronomy',c:34},
  {n:'Joshua',c:24},{n:'Judges',c:21},{n:'Ruth',c:4},{n:'1 Samuel',c:31},{n:'2 Samuel',c:24},
  {n:'1 Kings',c:22},{n:'2 Kings',c:25},{n:'1 Chronicles',c:29},{n:'2 Chronicles',c:36},{n:'Ezra',c:10},
  {n:'Nehemiah',c:13},{n:'Esther',c:10},{n:'Job',c:42},{n:'Psalms',c:150},{n:'Proverbs',c:31},
  {n:'Ecclesiastes',c:12},{n:'Song of Solomon',c:8},{n:'Isaiah',c:66},{n:'Jeremiah',c:52},{n:'Lamentations',c:5},
  {n:'Ezekiel',c:48},{n:'Daniel',c:12},{n:'Hosea',c:14},{n:'Joel',c:3},{n:'Amos',c:9},
  {n:'Obadiah',c:1},{n:'Jonah',c:4},{n:'Micah',c:7},{n:'Nahum',c:3},{n:'Habakkuk',c:3},
  {n:'Zephaniah',c:3},{n:'Haggai',c:2},{n:'Zechariah',c:14},{n:'Malachi',c:4},
  {n:'Matthew',c:28},{n:'Mark',c:16},{n:'Luke',c:24},{n:'John',c:21},{n:'Acts',c:28},
  {n:'Romans',c:16},{n:'1 Corinthians',c:16},{n:'2 Corinthians',c:13},{n:'Galatians',c:6},{n:'Ephesians',c:6},
  {n:'Philippians',c:4},{n:'Colossians',c:4},{n:'1 Thessalonians',c:5},{n:'2 Thessalonians',c:3},
  {n:'1 Timothy',c:6},{n:'2 Timothy',c:4},{n:'Titus',c:3},{n:'Philemon',c:1},{n:'Hebrews',c:13},
  {n:'James',c:5},{n:'1 Peter',c:5},{n:'2 Peter',c:3},{n:'1 John',c:5},{n:'2 John',c:1},{n:'3 John',c:1},
  {n:'Jude',c:1},{n:'Revelation',c:22}
];
const flatten=[]; const bookStartIndex={};
BOOKS.forEach(b=>{ bookStartIndex[b.n] = flatten.length; for(let i=1;i<=b.c;i++) flatten.push({book:b.n,chapter:i}); });
const NT_START = bookStartIndex['Matthew'];
const NT_END = flatten.length;

const refToUrl=(book,st,en,ver)=>{ const r=(en&&en!==st)?`${book} ${st}-${en}`:`${book} ${st}`; return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(r)}&version=${encodeURIComponent(ver)}`; };
const dayOfYear=(d=new Date())=> Math.floor((d - new Date(d.getFullYear(),0,1))/86400000);
function dailyDistribution(total,days=365){ const out=[]; for(let d=0; d<days; d++){ const t=Math.round(((d+1)*total)/days); const p=Math.round((d*total)/days); out.push(t-p);} return out; }
function buildRanges(counts,startIdx){ const out=[]; let idx=startIdx; for(const n of counts){ let start=flatten[idx]; let left=n; let last=start; while(left>0 && idx<flatten.length){ last=flatten[idx]; idx++; left--; } out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter}); } return out; }
function buildRangesLoop(counts, startIdx, endIdx){
  const out=[]; let idx=startIdx; const len=endIdx-startIdx;
  for(const n of counts){
    let start=flatten[idx]; let left = n; let last=start;
    while(left>0){ last=flatten[idx]; idx++; if(idx>=endIdx) idx=startIdx; left--; }
    out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter});
  }
  return out;
}

function psPrForDay(d){ if(d%2===0){ const ps=Math.floor(d/2)%150+1; return {book:'Psalms',start:ps,end:ps}; } const pr=Math.floor(d/2)%31+1; return {book:'Proverbs',start:pr,end:pr}; }
const OT_CHAPTERS = NT_START; // 929
const NT_CHAPTERS = NT_END - NT_START; // 260
const otPerDay = dailyDistribution(OT_CHAPTERS,365);
const ntPerDay = dailyDistribution(NT_CHAPTERS*2,365);
const OT_RANGES = buildRanges(otPerDay, 0);
const NT_RANGES = buildRangesLoop(ntPerDay, NT_START, NT_END);

function adultDay(d){ const ot=OT_RANGES[d], nt=NT_RANGES[d], pp=psPrForDay(d);
  return [{label:'Old Testament', book:ot.startBook, start:ot.startCh, end:ot.endCh, version:'ESV'},
          {label:'New Testament', book:nt.startBook, start:nt.startCh, end:nt.endCh, version:'ESV'},
          {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'ESV'}]; }
function kidsDay(d){ const main = d%2===0? {book:OT_RANGES[d].startBook, start:OT_RANGES[d].startCh, end:OT_RANGES[d].startCh}
                                          : {book:NT_RANGES[d].startBook, start:NT_RANGES[d].startCh, end:NT_RANGES[d].startCh};
  const pp=psPrForDay(d);
  return [{label:'Main Story', book:main.book, start:main.start, end:main.end, version:'NIrV'},
          {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'NIrV'}]; }

// ---- Summaries ----
const SHORT_SUMMARY = {
  Genesis:'Creation & Covenants', Exodus:'Moses & Rescue', Leviticus:'Holiness & Worship', Numbers:'Wilderness Journey', Deuteronomy:'Covenant Renewal',
  Joshua:'Conquest & Faith', Judges:'Cycles & Deliverers', Ruth:'Kindness & Redemption', '1 Samuel':'Kings & Calling', '2 Samuel':'David’s Reign',
  '1 Kings':'Kings & Prophets', '2 Kings':'Decline & Exile', '1 Chronicles':'Davidic History', '2 Chronicles':'Reform & Return',
  Ezra:'Return & Torah', Nehemiah:'Walls & Worship', Esther:'Providence & Courage',
  Job:'Suffering & Trust', Psalms:'Praise & Prayer', Proverbs:'Wisdom for Life', Ecclesiastes:'Meaning & Time', 'Song of Solomon':'Love & Devotion',
  Isaiah:'Hope & Holiness', Jeremiah:'Warning & Hope', Lamentations:'Grief & Hope', Ezekiel:'Visions & Restoration', Daniel:'Faith & Kingdom',
  Hosea:'Faithful Love', Joel:'Day of the Lord', Amos:'Justice & Mercy', Obadiah:'Pride & Fall', Jonah:'Mercy to Nineveh',
  Micah:'Justice & Hope', Nahum:'Nineveh Judged', Habakkuk:'Faith & Questions', Zephaniah:'Judgment & Joy', Haggai:'Rebuild & Priorities',
  Zechariah:'Visions & Messiah', Malachi:'Covenant & Promise',
  Matthew:'Messiah & Kingdom', Mark:'Power & Discipleship', Luke:'Savior for All', John:'Life in Christ', Acts:'Spirit & Mission',
  Romans:'Gospel & Righteousness', '1 Corinthians':'Church & Cross', '2 Corinthians':'Weakness & Strength',
  Galatians:'Grace & Freedom', Ephesians:'Church in Christ', Philippians:'Joy in Christ', Colossians:'Christ Supreme',
  '1 Thessalonians':'Hope & Holiness', '2 Thessalonians':'Christ’s Return',
  '1 Timothy':'Leaders & Teaching', '2 Timothy':'Finish Faithfully', Titus:'Healthy Church', Philemon:'Forgive & Restore',
  Hebrews:'Jesus Is Better', James:'Faith & Works', '1 Peter':'Hope in Trials', '2 Peter':'Grow in Grace',
  '1 John':'Love & Truth', '2 John':'Walk in Truth', '3 John':'Support the Truth', Jude:'Contend for Faith',
  Revelation:'Victory & New Creation'
};

function longSummaryFor(book){
  const M = {
    Torah: 'God forms a people through covenant, rescue, and instruction. These books reveal God’s character, humanity’s need, and a way to live with Him.',
    History: 'God’s faithfulness across generations—victories, failures, exile, and return. The story shows the cost of sin and the steadiness of God’s promises.',
    Wisdom: 'Poetry and wisdom for real life—prayer, praise, suffering, meaning, and love—teaching hearts to trust and live skillfully.',
    Prophets: 'God calls His people back through warnings and hope. The prophets expose sin, promise restoration, and point to the coming Messiah.',
    Gospels: 'The life, death, and resurrection of Jesus—the promised King who brings God’s kingdom near and invites us to follow Him.',
    Acts: 'The risen Jesus sends the Spirit. The church grows, suffers, and carries the gospel to the nations.',
    Epistles: 'Letters to help churches follow Jesus—clear teaching, correction, encouragement, and hope.',
    Revelation: 'Jesus reigns. Evil will not win. God will make all things new—so the church endures with courage and worship.'
  };
  const group = (function(b){
    if(['Genesis','Exodus','Leviticus','Numbers','Deuteronomy'].includes(b)) return 'Torah';
    if(['Job','Psalms','Proverbs','Ecclesiastes','Song of Solomon'].includes(b)) return 'Wisdom';
    if(['Joshua','Judges','Ruth','1 Samuel','2 Samuel','1 Kings','2 Kings','1 Chronicles','2 Chronicles','Ezra','Nehemiah','Esther'].includes(b)) return 'History';
    if(['Isaiah','Jeremiah','Lamentations','Ezekiel','Daniel','Hosea','Joel','Amos','Obadiah','Jonah','Micah','Nahum','Habakkuk','Zephaniah','Haggai','Zechariah','Malachi'].includes(b)) return 'Prophets';
    if(['Matthew','Mark','Luke','John'].includes(b)) return 'Gospels';
    if(b==='Acts') return 'Acts';
    if(['Romans','1 Corinthians','2 Corinthians','Galatians','Ephesians','Philippians','Colossians','1 Thessalonians','2 Thessalonians','1 Timothy','2 Timothy','Titus','Philemon','Hebrews','James','1 Peter','2 Peter','1 John','2 John','3 John','Jude'].includes(b)) return 'Epistles';
    if(b==='Revelation') return 'Revelation';
    return 'History';
  })(book);
  return M[group];
}

// Storage / State
const KEY='family-bible-reading-summaries-v2';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch{return{};} }
function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }
const defaultProfiles=[{id:'dad',name:'Dad',type:'adult'},{id:'mom',name:'Mom',type:'adult'},{id:'elle',name:'Elle',type:'kid'},{id:'lainey',name:'Lainey',type:'kid'}];

let S = Object.assign({profiles: defaultProfiles, activeId:'dad', offset:0, completed:{}, view:'single'}, load());
if(!Array.isArray(S.profiles) || S.profiles.length===0) S.profiles = defaultProfiles.slice();
if(!S.activeId || !S.profiles.some(p=>p.id===S.activeId)) S.activeId = S.profiles[0].id;
if(typeof S.offset !== 'number' || isNaN(S.offset)) S.offset = 0;
if(!S.completed || typeof S.completed!=='object') S.completed = {};
S.today = dayOfYear();
if(!S.view) S.view='single';

function isDone(pid, day, i){ const arr = S.completed[pid+':'+day]||[]; return arr.indexOf(i)!==-1; }
function toggle(pid, day, i){ const k=pid+':'+day; const set=new Set(S.completed[k]||[]); if(set.has(i)) set.delete(i); else set.add(i); S.completed[k]=Array.from(set); save(S); confetti(); render(); }
function markAll(pid, day, len){ S.completed[pid+':'+day]=Array.from({length:len},(_,i)=>i); save(S); confetti(); render(); }
function percent(pid, type){ let done=0; for(let d=0; d<=S.today; d++){ const key=pid+':'+d; const need=(type==='adult'?3:2); if((S.completed[key]||[]).length>=need) done++; } return Math.round((done/(S.today+1))*100); }
function current(profile, day){ return profile.type==='adult' ? adultDay(day) : kidsDay(day); }
function fmt(r){ return r.start===r.end? `${r.book} ${r.start}`:`${r.book} ${r.start}-${r.end}`; }
function imgFor(i){ const n=(i%6)+1; return `images/kid-${n}.png`; }
function confetti(){ const host=document.getElementById('confetti'); if(!host) return; const pieces=16; const W=window.innerWidth, H=window.innerHeight; for(let i=0;i<pieces;i++){ const s=document.createElement('div'); s.className='piece'; s.style.left=(W/2)+'px'; s.style.top=(H/3)+'px'; const dx=(Math.random()*2-1)*W*0.6; const dy=H*(0.6+Math.random()*0.4); s.style.setProperty('--dx', dx+'px'); s.style.setProperty('--dy', dy+'px'); s.textContent = ['🎉','✨','🌟','💫','🎈','🟡','🟣','🔵'][i%8]; host.appendChild(s); setTimeout(()=> host.removeChild(s), 1300);} }

// UI helpers
function openModal(imgSrc, title, ref, body, link){
  const bg = document.getElementById('modalBg');
  document.getElementById('modalImg').src = imgSrc||'';
  document.getElementById('modalTitle').textContent = title||'';
  document.getElementById('modalRef').textContent = ref||'';
  document.getElementById('modalBody').textContent = body||'';
  document.getElementById('modalLink').href = link||'#';
  bg.style.display='flex';
}
document.getElementById('modalClose').onclick = ()=>{ document.getElementById('modalBg').style.display='none'; };
document.getElementById('modalBg').onclick = (e)=>{ if(e.target.id==='modalBg'){ e.currentTarget.style.display='none'; } };

function shortSummaryFor(book){
  return SHORT_SUMMARY[book] || 'Read & Reflect';
}
function longSummaryForBook(book){
  return longSummaryFor(book);
}
function makeShortPill(text, onClick){
  const pill = document.createElement('span');
  pill.className = 'short-pill';
  pill.textContent = text;
  pill.onclick = onClick;
  return pill;
}

// Overview toggle
(function(){
  const viewSel = document.getElementById('overview');
  viewSel.value = S.view || 'single';
  viewSel.onchange = e=>{ S.view = e.target.value; save(S); render(); };
})();

// Theme select
(function(){
  const sel = document.getElementById('theme');
  try{
    const saved = localStorage.getItem('fbr-theme') || 'auto';
    sel.value = saved;
  }catch(e){ sel.value = 'auto'; }
  sel.onchange = (e)=>{
    const v = e.target.value || 'auto';
    if(window._setTheme) window._setTheme(v);
  };
})();

function addSummaryPill(container, r, isKid, i){
  const short = shortSummaryFor(r.book);
  const pill = makeShortPill(short, ()=>{
    const img = isKid ? imgFor(i) : '';
    const title = short;
    const ref = fmt(r);
    const body = longSummaryForBook(r.book);
    openModal(img, title, ref, body, refToUrl(r.book,r.start,r.end,r.version));
  });
  const tag=document.createElement('div'); tag.className='text-sm uppercase tracking-wide muted'; tag.textContent=r.label;
  const topRow=document.createElement('div'); topRow.className='flex items-center gap-2';
  topRow.appendChild(tag); topRow.appendChild(pill);
  container.appendChild(topRow);
}

// Rendering
function renderSingle(){
  const userSel = document.getElementById('user');
  userSel.innerHTML='';
  S.profiles.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(p.id===S.activeId) o.selected=true; userSel.appendChild(o); });
  userSel.onchange = e=>{ S.activeId=e.target.value; save(S); render(); };

  const p = S.profiles.find(x=>x.id===S.activeId)||S.profiles[0];
  document.getElementById('progressPct').textContent = percent(p.id, p.type)+'%';
  const idx = (S.today + S.offset + 365)%365;
  const readings = current(p, idx);

  const cards = document.getElementById('cards');
  cards.innerHTML='';
  readings.forEach((r,i)=>{
    const card=document.createElement('div');
    const kid = p.type==='kid';
    card.className='p-4 rounded-2xl '+(kid?'card':'adult-card')+(isDone(p.id,S.today,i)?' completed':'');

    const row=document.createElement('div'); row.className='flex items-center gap-4 justify-between';

    const left=document.createElement('div'); left.className='flex-1';
    addSummaryPill(left, r, kid, i);
    const titleEl=document.createElement('div'); titleEl.className='text-xl font-semibold'; titleEl.textContent=fmt(r);
    const a=document.createElement('a'); a.className='text-sm underline'; a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')';
    left.appendChild(titleEl); left.appendChild(a);

    if(kid){
      const img=document.createElement('img'); img.src=imgFor(i); img.alt='Sticker'; img.className='kid-sticker';
      row.appendChild(img);
    }

    const btn=document.createElement('button'); btn.className='px-3 py-2 rounded '+(isDone(p.id,S.today,i)?'bg-green-600 text-white':'bordered bg-transparent'); btn.textContent=isDone(p.id,S.today,i)?'✅ Done':'Mark complete';
    btn.onclick=()=> toggle(p.id,S.today,i);

    row.appendChild(left);
    row.appendChild(btn);
    card.appendChild(row);
    cards.appendChild(card);
  });

  document.getElementById('peekTitle').textContent = p.type==='adult' ? 'Tomorrow (Adults • ESV)' : 'Tomorrow (Kids • NIrV)';
  const peek = document.getElementById('peek');
  peek.innerHTML='';
  const tmr = current(p, (S.today+1)%365);
  tmr.forEach((r,i)=>{
    const row=document.createElement('div'); row.className='p-3 rounded-xl card flex items-center justify-between gap-4';
    const left=document.createElement('div');
    addSummaryPill(left, r, p.type==='kid', i+1);
    const l2=document.createElement('div'); l2.className='font-medium'; l2.textContent=fmt(r);
    const a=document.createElement('a'); a.className='text-xs underline'; a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')';
    left.appendChild(l2); left.appendChild(a);
    if(p.type==='kid'){ const img=document.createElement('img'); img.src=imgFor(i+1); img.alt='Sticker'; img.className='kid-sticker'; row.appendChild(img); }
    row.appendChild(left);
    peek.appendChild(row);
  });
}

function renderKidsOverview(){
  const cards = document.getElementById('cards');
  cards.innerHTML='';
  const kids = S.profiles.filter(x=>x.type==='kid');
  const wrap = document.createElement('div'); wrap.className='grid md:grid-cols-2 gap-4';
  cards.appendChild(wrap);

  kids.forEach((kidP, colIdx)=>{
    const box = document.createElement('div'); box.className='p-4 rounded-2xl card';
    const h = document.createElement('div'); h.className='flex items-center justify-between mb-2';
    const t = document.createElement('div'); t.innerHTML = '<div class="text-sm uppercase tracking-wide muted">Today</div><div class="text-lg font-semibold">'+kidP.name+'</div>';
    const pct = document.createElement('div'); pct.className='text-sm muted'; pct.textContent = percent(kidP.id, kidP.type)+'%';
    h.appendChild(t); h.appendChild(pct); box.appendChild(h);

    const idx = (S.today + S.offset + 365)%365;
    const readings = current(kidP, idx);
    readings.forEach((r,i)=>{
      const row=document.createElement('div'); row.className='flex items-center gap-4 justify-between p-3 rounded-xl bordered mb-2';
      const left=document.createElement('div'); left.className='flex-1';
      addSummaryPill(left, r, true, i+colIdx);
      const l2=document.createElement('div'); l2.className='font-medium'; l2.textContent=fmt(r);
      const a=document.createElement('a'); a.className='text-xs underline'; a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')';
      left.appendChild(l2); left.appendChild(a);
      const img=document.createElement('img'); img.src=imgFor(i+colIdx+1); img.alt='Sticker'; img.className='kid-sticker';
      const btn=document.createElement('button'); btn.className='px-3 py-2 rounded '+(isDone(kidP.id,S.today,i)?'bg-green-600 text-white':'bordered bg-transparent'); btn.textContent=isDone(kidP.id,S.today,i)?'✅ Done':'Mark complete';
      btn.onclick=()=> toggle(kidP.id,S.today,i);
      row.appendChild(img); row.appendChild(left); row.appendChild(btn);
      box.appendChild(row);
    });

    wrap.appendChild(box);
  });

  // Peek section for overview
  const peekWrap = document.createElement('div'); peekWrap.className='mt-4 p-4 rounded-2xl card';
  const title = document.createElement('div'); title.className='text-sm muted'; title.textContent='Peek ahead (Kids)';
  peekWrap.appendChild(title);
  const grid = document.createElement('div'); grid.className='grid md:grid-cols-2 gap-3 mt-3'; peekWrap.appendChild(grid);
  kids.forEach((kidP, colIdx)=>{
    const col = document.createElement('div'); col.className='rounded-xl p-3 bordered';
    const name = document.createElement('div'); name.className='font-semibold mb-1'; name.textContent = kidP.name;
    col.appendChild(name);
    const tmr = current(kidP, (S.today+1)%365);
    tmr.forEach((r,i)=>{
      const row=document.createElement('div'); row.className='flex items-center gap-3 justify-between p-2 rounded-lg bordered mb-2';
      const left=document.createElement('div'); left.className='flex-1';
      addSummaryPill(left, r, true, i+colIdx+2);
      const l2=document.createElement('div'); l2.className='text-sm'; l2.textContent=fmt(r);
      left.appendChild(l2);
      const img=document.createElement('img'); img.src=imgFor(i+colIdx+2); img.alt='Sticker'; img.className='kid-sticker';
      row.appendChild(img); row.appendChild(left);
      col.appendChild(row);
    });
    grid.appendChild(col);
  });

  cards.appendChild(peekWrap);
}

function render(){
  const viewSel = document.getElementById('overview');
  if(S.view==='kids'){ viewSel.value='kids'; }
  else { viewSel.value='single'; }

  // Wire buttons
  document.getElementById('yesterday').onclick = ()=>{ S.today=(S.today+364)%365; render(); };
  document.getElementById('tomorrow').onclick  = ()=>{ S.today=(S.today+1)%365; render(); };
  document.getElementById('prev').onclick      = ()=>{ S.offset--; render(); };
  document.getElementById('next').onclick      = ()=>{ S.offset++; render(); };
  document.getElementById('markAll').onclick   = ()=>{ const p = S.profiles.find(x=>x.id===S.activeId)||S.profiles[0]; const r=current(p, (S.today+S.offset+365)%365); markAll(p.id, S.today, r.length); };

  if(S.view==='kids'){
    renderKidsOverview();
    document.getElementById('peekTitle').textContent = 'Tomorrow';
    document.getElementById('peek').innerHTML='';
  }else{
    renderSingle();
  }
}
render();
</script>
</body>
</html>
