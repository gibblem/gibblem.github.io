<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width,initial-scale=1'/>
<title>Family Bible Reading</title>
<link rel='manifest' href='manifest.json'>
<meta name='apple-mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'>
<meta name='apple-mobile-web-app-title' content='Bible Reading'>
<link rel='apple-touch-icon' href='icons/icon-192x192.png'>
<script src='https://unpkg.com/react@18/umd/react.production.min.js'></script>
<script src='https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'></script>
<script src='https://unpkg.com/babel-standalone@6/babel.min.js'></script>
<link href='https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css' rel='stylesheet'>
<meta name='theme-color' content='#0ea5e9'>
<style>
  .kid-card { background: linear-gradient(180deg,#fffbe6,#ffe7f0); }
  .adult-card { background: linear-gradient(180deg,#f0f9ff,#e0f2fe); }
  .completed { border-color:#10b981!important; box-shadow:0 0 0 2px #10b98133 inset; }
</style>
</head>
<body class='bg-gray-50'>
<div id='root'></div>

<!-- IMPORTANT: data-presets added so JSX compiles on GitHub Pages -->
<script type='text/babel' data-presets='env,react'>
const {useState,useEffect,useMemo} = React;
const BOOKS=[
{n:'Genesis',c:50},{n:'Exodus',c:40},{n:'Leviticus',c:27},{n:'Numbers',c:36},{n:'Deuteronomy',c:34},
{n:'Joshua',c:24},{n:'Judges',c:21},{n:'Ruth',c:4},{n:'1 Samuel',c:31},{n:'2 Samuel',c:24},
{n:'1 Kings',c:22},{n:'2 Kings',c:25},{n:'1 Chronicles',c:29},{n:'2 Chronicles',c:36},{n:'Ezra',c:10},
{n:'Nehemiah',c:13},{n:'Esther',c:10},{n:'Job',c:42},{n:'Psalms',c:150},{n:'Proverbs',c:31},
{n:'Ecclesiastes',c:12},{n:'Song of Solomon',c:8},{n:'Isaiah',c:66},{n:'Jeremiah',c:52},{n:'Lamentations',c:5},
{n:'Ezekiel',c:48},{n:'Daniel',c:12},{n:'Hosea',c:14},{n:'Joel',c:3},{n:'Amos',c:9},
{n:'Obadiah',c:1},{n:'Jonah',c:4},{n:'Micah',c:7},{n:'Nahum',c:3},{n:'Habakkuk',c:3},
{n:'Zephaniah',c:3},{n:'Haggai',c:2},{n:'Zechariah',c:14},{n:'Malachi',c:4},
{n:'Matthew',c:28},{n:'Mark',c:16},{n:'Luke',c:24},{n:'John',c:21},{n:'Acts',c:28},
{n:'Romans',c:16},{n:'1 Corinthians',c:16},{n:'2 Corinthians',c:13},{n:'Galatians',c:6},{n:'Ephesians',c:6},
{n:'Philippians',c:4},{n:'Colossians',c:4},{n:'1 Thessalonians',c:5},{n:'2 Thessalonians',c:3},
{n:'1 Timothy',c:6},{n:'2 Timothy',c:4},{n:'Titus',c:3},{n:'Philemon',c:1},{n:'Hebrews',c:13},
{n:'James',c:5},{n:'1 Peter',c:5},{n:'2 Peter',c:3},{n:'1 John',c:5},{n:'2 John',c:1},{n:'3 John',c:1},
{n:'Jude',c:1},{n:'Revelation',c:22}
];
const flatten=[]; BOOKS.forEach(b=>{for(let i=1;i<=b.c;i++) flatten.push({book:b.n,chapter:i});});
const findStart=(name)=> flatten.findIndex(x=>x.book===name && x.chapter===1);
const isNT=(book)=> BOOKS.findIndex(b=>b.n===book)>=39;
const refToUrl=(book,st,en,ver)=>{
 const r= en && en!==st ? `${book} ${st}-${en}` : `${book} ${st}`;
 return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(r)}&version=${encodeURIComponent(ver)}`;
};
function dailyDistribution(total,days=365){
  const out=[];
  for(let d=0;d<days;d++){
    const t=Math.round(((d+1)*total)/days);
    const p=Math.round((d*total)/days);
    out.push(t-p);
  }
  return out;
}
const OT_CHAPTERS = findStart('Matthew'); // 929
const NT_CHAPTERS = flatten.length - OT_CHAPTERS; // 260
const otPerDay = dailyDistribution(OT_CHAPTERS,365);
const ntPerDay = dailyDistribution(NT_CHAPTERS*2,365);
function buildRanges(counts,startIdx){
  const out=[]; let idx=startIdx;
  for(const n of counts){
    let start=flatten[idx]; let left=n; let last= start;
    while(left>0 && idx<flatten.length){ last=flatten[idx]; idx++; left--; }
    out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter});
  }
  return out;
}
function psPrForDay(d){
  if(d%2===0){ const ps=Math.floor(d/2)%150+1; return {book:'Psalms',start:ps,end:ps}; }
  const pr=Math.floor(d/2)%31+1; return {book:'Proverbs',start:pr,end:pr};
}
const OT_RANGES = buildRanges(otPerDay,0);
const NT_RANGES = buildRanges(ntPerDay,findStart('Matthew'));

function adultDay(d){
  const ot=OT_RANGES[d], nt=NT_RANGES[d], pp=psPrForDay(d);
  return [
    {label:'Old Testament', book:ot.startBook, start:ot.startCh, end:ot.endCh, version:'ESV'},
    {label:'New Testament', book:nt.startBook, start:nt.startCh, end:nt.endCh, version:'ESV'},
    {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'ESV'}
  ];
}
function kidsDay(d){
  const main = d%2===0 ? {book:OT_RANGES[d].startBook, start:OT_RANGES[d].startCh, end:OT_RANGES[d].startCh}
                        : {book:NT_RANGES[d].startBook, start:NT_RANGES[d].startCh, end:NT_RANGES[d].startCh};
  const pp=psPrForDay(d);
  return [
    {label:'Main Story', book:main.book, start:main.start, end:main.end, version:'NIrV'},
    {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'NIrV'}
  ];
}
const KEY='family-bible-reading-v4';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch{return{};} }
function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }
const defaultProfiles=[
 {id:'dad',name:'Dad',type:'adult'},
 {id:'mom',name:'Mom',type:'adult'},
 {id:'elle',name:'Elle',type:'kid'},
 {id:'lainey',name:'Lainey',type:'kid'}
];
function dayOfYear(d=new Date()){ const s=new Date(d.getFullYear(),0,1); return Math.floor((d-s)/86400000); }

function App(){
  const [profiles,setProfiles]=React.useState(()=> load().profiles||defaultProfiles);
  const [activeId,setActiveId]=React.useState(()=> load().activeId|| (load().profiles||defaultProfiles)[0].id);
  const [offset,setOffset]=React.useState(0);
  const [today,setToday]=React.useState(dayOfYear());
  const [data,setData]=React.useState(()=>load());

  React.useEffect(()=>{ save({...data,profiles,activeId}); },[data,profiles,activeId]);

  const active = profiles.find(p=>p.id===activeId)||profiles[0];
  const idx = (today + offset + 365)%365;
  const readings = React.useMemo(()=> active.type==='adult'? adultDay(idx): kidsDay(idx), [active, idx]);
  const tomorrow = React.useMemo(()=> active.type==='adult'? adultDay((today+1)%365): kidsDay((today+1)%365), [active, today]);

  function toggleCard(i, day=today){
    const s=load(); const key=`${activeId}:${day}`; const set=new Set(s.completed?.[key]||[]);
    if(set.has(i)) set.delete(i); else set.add(i);
    const completed={...(s.completed||{}), [key]: Array.from(set)};
    setData({...s, completed});
  }
  function isDone(i, day=today){
    const s=load(); const key=`${activeId}:${day}`; return (s.completed?.[key]||[]).includes(i);
  }
  function markAll(){
    const s=load(); const key=`${activeId}:${today}`;
    const completed={...(s.completed||{}), [key]: readings.map((_,i)=>i)};
    setData({...s, completed});
  }
  const percent = React.useMemo(()=>{
    const s=load(); let done=0;
    for(let d=0; d<=today; d++){
      const key=`${activeId}:${d}`;
      const need = (active.type==='adult'?3:2);
      if((s.completed?.[key]||[]).length>=need) done++;
    }
    return Math.round((done/(today+1))*100);
  },[data,active,today]);

  return (<div className='max-w-3xl mx-auto px-4 py-6'>
    <header className='flex items-center justify-between mb-4'>
      <div>
        <h1 className='text-2xl font-bold'>Family Bible Reading</h1>
        <p className='text-sm text-gray-500'>Adults (ESV) • Kids (NIrV) • Mixed plan • Links • Per-person progress</p>
      </div>
      <div className='text-right'>
        <div className='text-sm text-gray-600'>Progress</div>
        <div className='text-lg font-semibold'>{percent}%</div>
      </div>
    </header>

    <div className='flex flex-wrap items-center gap-2 mb-3'>
      <label className='text-sm'>User:</label>
      <select className='border rounded p-2' value={activeId} onChange={e=>setActiveId(e.target.value)}>
        {profiles.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
      </select>
      <button className='ml-auto px-3 py-2 rounded border' onClick={()=>setToday(d=>(d+364)%365)}>← Yesterday</button>
      <button className='px-3 py-2 rounded border' onClick={()=>setToday(d=>(d+1)%365)}>Tomorrow →</button>
      <button className='px-3 py-2 rounded border' onClick={()=>setOffset(o=>o-1)}>◀ Previous suggestion</button>
      <button className='px-3 py-2 rounded border' onClick={()=>setOffset(o=>o+1)}>Next suggestion ▶</button>
      <button className='px-3 py-2 rounded bg-green-600 text-white' onClick={markAll}>Mark all complete</button>
    </div>

    <div className='grid gap-3'>
      {readings.map((r,i)=>{
        const url = refToUrl(r.book, r.start, r.end, r.version);
        const kid = active.type==='kid';
        const cls = `p-4 rounded-2xl border ${kid?'kid-card':'adult-card'} ${isDone(i)?'completed':''}`;
        return (<div className={cls} key={i}>
          <div className='flex items-center justify-between'>
            <div>
              <div className='text-sm uppercase tracking-wide text-gray-500'>{r.label}</div>
              <div className='text-xl font-semibold'>{r.start===r.end? `${r.book} ${r.start}` : `${r.book} ${r.start}-${r.end}`}</div>
              <a className='text-sm underline' href={url} target='_blank' rel='noreferrer'>Read now ({r.version})</a>
            </div>
            <button onClick={()=>toggleCard(i)} className={'px-3 py-2 rounded '+(isDone(i)?'bg-green-600 text-white':'border')}>
              {isDone(i)?'✅ Done':'Mark complete'}
            </button>
          </div>
        </div>);
      })}
    </div>

    <div className='mt-6 p-4 rounded-2xl border bg-white'>
      <div className='text-sm text-gray-500'>Peek ahead</div>
      <div className='text-lg font-semibold'>{active.type==='adult'?'Tomorrow (Adults • ESV)':'Tomorrow (Kids • NIrV)'}</div>
      <div className='grid gap-3 mt-3'>
        {tomorrow.map((r,i)=>{
          const url=refToUrl(r.book,r.start,r.end,r.version);
          return (<div key={i} className='p-3 rounded-xl border bg-gray-50'>
            <div className='text-sm uppercase tracking-wide text-gray-500'>{r.label}</div>
            <div className='font-medium'>{r.start===r.end? `${r.book} ${r.start}` : `${r.book} ${r.start}-${r.end}`}</div>
            <a className='text-xs underline' href={url} target='_blank' rel='noreferrer'>Read now ({r.version})</a>
          </div>);
        })}
      </div>
    </div>

    <footer className='text-center text-xs text-gray-500 mt-6'>
      Add to iOS Home Screen: Share → “Add to Home Screen”. Works offline after first load.
    </footer>
  </div>);
}
ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>

<script>
if('serviceWorker' in navigator){ window.addEventListener('load',()=> navigator.serviceWorker.register('sw.js')); }
</script>
</body>
</html>
