<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bible App — Fallback</title>
  <meta name="robots" content="noindex">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; background: #f6f7fb; color:#0f172a; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; max-width:720px; margin:0 auto; box-shadow: 0 10px 20px rgba(0,0,0,.04); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn { padding:8px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; cursor:pointer; }
    .btn.primary { background:#059669; color:#fff; border-color:#059669; }
    .tag { font-size:12px; color:#64748b; text-transform:uppercase; letter-spacing:.06em; }
    .done { background:#ecfdf5; border-color:#10b981; }
    .muted { color:#64748b; font-size:12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Family Bible Reading — Fallback</h1>
    <p class="muted" id="status">Booting…</p>
    <div class="row" style="margin:8px 0">
      <label>User: <select id="user"></select></label>
      <button class="btn" id="yesterday">← Yesterday</button>
      <button class="btn" id="tomorrow">Tomorrow →</button>
      <button class="btn" id="prev">◀ Previous suggestion</button>
      <button class="btn" id="next">Next suggestion ▶</button>
      <button class="btn primary" id="markAll">Mark all complete</button>
    </div>
    <div id="readings"></div>
    <div style="margin-top:16px">
      <div class="tag">Peek ahead</div>
      <div id="peek"></div>
    </div>
  </div>

<script>
console.log("Fallback build starting");
const BOOKS=[
{n:'Genesis',c:50},{n:'Exodus',c:40},{n:'Leviticus',c:27},{n:'Numbers',c:36},{n:'Deuteronomy',c:34},
{n:'Joshua',c:24},{n:'Judges',c:21},{n:'Ruth',c:4},{n:'1 Samuel',c:31},{n:'2 Samuel',c:24},
{n:'1 Kings',c:22},{n:'2 Kings',c:25},{n:'1 Chronicles',c:29},{n:'2 Chronicles',c:36},{n:'Ezra',c:10},
{n:'Nehemiah',c:13},{n:'Esther',c:10},{n:'Job',c:42},{n:'Psalms',c:150},{n:'Proverbs',c:31},
{n:'Ecclesiastes',c:12},{n:'Song of Solomon',c:8},{n:'Isaiah',c:66},{n:'Jeremiah',c:52},{n:'Lamentations',c:5},
{n:'Ezekiel',c:48},{n:'Daniel',c:12},{n:'Hosea',c:14},{n:'Joel',c:3},{n:'Amos',c:9},
{n:'Obadiah',c:1},{n:'Jonah',c:4},{n:'Micah',c:7},{n:'Nahum',c:3},{n:'Habakkuk',c:3},
{n:'Zephaniah',c:3},{n:'Haggai',c:2},{n:'Zechariah',c:14},{n:'Malachi',c:4},
{n:'Matthew',c:28},{n:'Mark',c:16},{n:'Luke',c:24},{n:'John',c:21},{n:'Acts',c:28},
{n:'Romans',c:16},{n:'1 Corinthians',c:16},{n:'2 Corinthians',c:13},{n:'Galatians',c:6},{n:'Ephesians',c:6},
{n:'Philippians',c:4},{n:'Colossians',c:4},{n:'1 Thessalonians',c:5},{n:'2 Thessalonians',c:3},
{n:'1 Timothy',c:6},{n:'2 Timothy',c:4},{n:'Titus',c:3},{n:'Philemon',c:1},{n:'Hebrews',c:13},
{n:'James',c:5},{n:'1 Peter',c:5},{n:'2 Peter',c:3},{n:'1 John',c:5},{n:'2 John',c:1},{n:'3 John',c:1},
{n:'Jude',c:1},{n:'Revelation',c:22}
];
const flatten=[]; BOOKS.forEach(b=>{for(let i=1;i<=b.c;i++) flatten.push({book:b.n,chapter:i});});
const findStart=(name)=> flatten.findIndex(x=>x.book===name && x.chapter===1);
const refToUrl=(book,st,en,ver)=>{ const r=(en&&en!==st)?`${book} ${st}-${en}`:`${book} ${st}`; return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(r)}&version=${encodeURIComponent(ver)}`; };
const dayOfYear=(d=new Date())=> Math.floor((d - new Date(d.getFullYear(),0,1))/86400000);
function dailyDistribution(total,days=365){ const out=[]; for(let d=0; d<days; d++){ const t=Math.round(((d+1)*total)/days); const p=Math.round((d*total)/days); out.push(t-p);} return out; }
function buildRanges(counts,startIdx){ const out=[]; let idx=startIdx; for(const n of counts){ let start=flatten[idx]; let left=n; let last=start; while(left>0 && idx<flatten.length){ last=flatten[idx]; idx++; left--; } out.push({startBook:start.book,startCh:start.chapter,endBook:last.book,endCh:last.chapter}); } return out; }
function psPrForDay(d){ if(d%2===0){ const ps=Math.floor(d/2)%150+1; return {book:'Psalms',start:ps,end:ps}; } const pr=Math.floor(d/2)%31+1; return {book:'Proverbs',start:pr,end:pr}; }

const OT_CHAPTERS = findStart('Matthew'); // 929
const NT_CHAPTERS = flatten.length - OT_CHAPTERS; // 260
const otPerDay = dailyDistribution(OT_CHAPTERS,365);
const ntPerDay = dailyDistribution(NT_CHAPTERS*2,365);
const OT_RANGES = buildRanges(otPerDay,0);
const NT_RANGES = buildRanges(ntPerDay,findStart('Matthew'));

function adultDay(d){ const ot=OT_RANGES[d], nt=NT_RANGES[d], pp=psPrForDay(d);
  return [{label:'Old Testament', book:ot.startBook, start:ot.startCh, end:ot.endCh, version:'ESV'},
          {label:'New Testament', book:nt.startBook, start:nt.startCh, end:nt.endCh, version:'ESV'},
          {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'ESV'}]; }
function kidsDay(d){ const main=d%2===0?{book:OT_RANGES[d].startBook,start:OT_RANGES[d].startCh,end:OT_RANGES[d].startCh}:{book:NT_RANGES[d].startBook,start:NT_RANGES[d].startCh,end:NT_RANGES[d].startCh}; const pp=psPrForDay(d);
  return [{label:'Main Story', book:main.book, start:main.start, end:main.end, version:'NIrV'},
          {label: pp.book==='Psalms'?'Psalm':'Proverb', book:pp.book, start:pp.start, end:pp.end, version:'NIrV'}]; }

const KEY='family-bible-reading-v6';
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||{};}catch{return{};} }
function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }
const defaultProfiles=[{id:'dad',name:'Dad',type:'adult'},{id:'mom',name:'Mom',type:'adult'},{id:'elle',name:'Elle',type:'kid'},{id:'lainey',name:'Lainey',type:'kid'}];

let S = load();
if(!S.profiles) S.profiles = defaultProfiles;
if(!S.activeId) S.activeId = S.profiles[0].id;
if(typeof S.offset!=='number') S.offset=0;
if(!S.completed) S.completed={};
S.today = dayOfYear();

function isDone(pid, day, i){ const arr = S.completed[pid+':'+day]||[]; return arr.indexOf(i)!==-1; }
function toggle(pid, day, i){ const k=pid+':'+day; const set=new Set(S.completed[k]||[]); if(set.has(i)) set.delete(i); else set.add(i); S.completed[k]=Array.from(set); save(S); render(); }
function markAll(pid, day, len){ S.completed[pid+':'+day]=Array.from({length:len},(_,i)=>i); save(S); render(); }
function percent(pid, type){
  let done=0;
  for(let d=0; d<=S.today; d++){ const key=pid+':'+d; const need= (type==='adult'?3:2); if((S.completed[key]||[]).length>=need) done++; }
  return Math.round((done/(S.today+1))*100);
}
function current(profile, day){ return profile.type==='adult' ? adultDay(day) : kidsDay(day); }
function fmt(r){ return r.start===r.end? `${r.book} ${r.start}`:`${r.book} ${r.start}-${r.end}`; }

function render(){
  console.log('render() start', JSON.stringify(S));
  const root = document.getElementById('root');
  if(!root){ console.error('root missing'); return; }
  root.innerHTML='';
  const card=document.createElement('div'); card.className='card'; root.appendChild(card);
  const h1=document.createElement('h1'); h1.textContent='Family Bible Reading'; card.appendChild(h1);
  const p=document.createElement('p'); p.className='muted'; p.textContent='Adults (ESV) • Kids (NIrV) • Mixed plan • Per-person progress'; card.appendChild(p);
  const status=document.getElementById('status'); if(status) status.textContent='Ready';

  const row=document.createElement('div'); row.className='row'; card.appendChild(row);
  const lab=document.createElement('label'); lab.innerHTML='User: <select id="user"></select>'; row.appendChild(lab);
  const select=lab.querySelector('select'); S.profiles.forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=x.name; if(x.id===S.activeId) o.selected=true; select.appendChild(o); });
  select.onchange=e=>{ S.activeId=e.target.value; save(S); render(); };

  function button(txt, handler){ const b=document.createElement('button'); b.className='btn'; b.textContent=txt; b.onclick=handler; return b; }
  const yBtn=button('← Yesterday', ()=>{ S.today=(S.today+364)%365; render(); }); yBtn.classList.add('ml-auto'); row.appendChild(yBtn);
  row.appendChild(button('Tomorrow →', ()=>{ S.today=(S.today+1)%365; render(); }));
  row.appendChild(button('◀ Previous suggestion', ()=>{ S.offset--; render(); }));
  row.appendChild(button('Next suggestion ▶', ()=>{ S.offset++; render(); }));
  const allBtn=button('Mark all complete', ()=>{}); allBtn.classList.add('primary'); row.appendChild(allBtn);

  const profile = S.profiles.find(x=>x.id===S.activeId)||S.profiles[0];
  const dayIdx = (S.today + S.offset + 365)%365;
  const readings=current(profile, dayIdx);
  allBtn.onclick=()=> markAll(profile.id, S.today, readings.length);

  const pct=document.createElement('div'); pct.className='muted'; pct.textContent='Progress: '+percent(profile.id, profile.type)+'%'; card.appendChild(pct);

  const list=document.createElement('div'); list.id='readings'; card.appendChild(list);
  readings.forEach((r,i)=>{
    const c=document.createElement('div'); c.className='row'; c.style.cssText='justify-content:space-between;border:1px solid #e5e7eb;padding:12px;border-radius:12px;margin-top:8px;'+(isDone(profile.id,S.today,i)?'background:#ecfdf5;border-color:#10b981;':'');
    const left=document.createElement('div');
    const tag=document.createElement('div'); tag.className='tag'; tag.textContent=r.label;
    const title=document.createElement('div'); title.style.fontWeight='600'; title.textContent=fmt(r);
    const a=document.createElement('a'); a.href=refToUrl(r.book,r.start,r.end,r.version); a.target='_blank'; a.rel='noreferrer'; a.textContent='Read now ('+r.version+')'; a.style.fontSize='12px';
    left.appendChild(tag); left.appendChild(title); left.appendChild(a);
    const right=button(isDone(profile.id,S.today,i)?'✅ Done':'Mark complete', ()=>toggle(profile.id,S.today,i));
    if(isDone(profile.id,S.today,i)) right.classList.add('done'); else right.classList.remove('done');
    c.appendChild(left); c.appendChild(right);
    list.appendChild(c);
  });

  const peek=document.createElement('div'); peek.style.cssText='margin-top:16px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;'; card.appendChild(peek);
  const peekTag=document.createElement('div'); peekTag.className='tag'; peekTag.textContent='Peek ahead'; peek.appendChild(peekTag);
  const peekGrid=document.createElement('div'); peek.appendChild(peekGrid);
  const tom=current(profile, (S.today+1)%365);
  tom.forEach(r=>{ const row=document.createElement('div'); row.className='row'; row.style.cssText='justify-content:space-between;border:1px solid #f1f5f9; padding:8px; border-radius:10px; background:#f8fafc; margin-top:6px;'; const l1=document.createElement('div'); l1.textContent=fmt(r); l1.style.fontWeight='500'; const l2=document.createElement('a'); l2.href=refToUrl(r.book,r.start,r.end,r.version); l2.target='_blank'; l2.rel='noreferrer'; l2.textContent='Read now ('+r.version+')'; l2.style.fontSize='12px'; row.appendChild(l1); row.appendChild(l2); peekGrid.appendChild(row); });
}
render();
</script>
</body>
</html>
